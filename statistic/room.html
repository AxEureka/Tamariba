<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ«ãƒ¼ãƒ </title>

<style>
html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  font-family: sans-serif;
  color: white;
}
body { background-size: cover; background-position: center; }
.exit { position: fixed; top: 20px; right: 20px; padding: 8px 14px; cursor: pointer; }
.room-ui { background: rgba(0,0,0,0.65); padding: 24px; margin: 40px; border-radius: 14px; max-width: 600px; }
button { cursor: pointer; padding: 6px 12px; margin-left: 6px; }
#join-url { width: 36ch; }
#popup { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 12px 18px; border-radius: 10px; display: none; }
</style>
</head>

<body>

<button class="exit" onclick="exitRoom()">é€€å‡º</button>

<div class="room-ui">
  <h1 id="room-title">èª­ã¿è¾¼ã¿ä¸­...</h1>

  <p>
    ãƒ«ãƒ¼ãƒ IDï¼š<strong id="room-id"></strong> /
    å‚åŠ äººæ•°ï¼š<strong id="count">0</strong>äºº
    <button onclick="toggleMembers()">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¦‹ã‚‹</button>
  </p>

  <div id="members" style="display:none; margin-bottom:10px;"></div>

  <p id="join-url-container">
    å‚åŠ URLï¼š
    <input id="join-url" readonly>
    <button onclick="copyURL()">ã‚³ãƒ”ãƒ¼</button>
  </p>

  <div id="host-only" style="display:none; margin-top:20px;">
    <button onclick="selectGame()">ğŸ® ã‚²ãƒ¼ãƒ ã‚’é¸ã¶ï¼ˆè¦ªã®ã¿ï¼‰</button>
  </div>
</div>

<div id="popup"></div>

<script>
const params = new URLSearchParams(location.search);
const roomId = params.get("room");
let myName = params.get("name") || "";

let hostName = "";
let lastCount = 0;

// ===== ãƒ«ãƒ¼ãƒ æƒ…å ±èª­ã¿è¾¼ã¿ =====
async function loadRoom() {
  const res = await fetch(`/room/${roomId}`);
  if (!res.ok) { alert("ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
  const data = await res.json();
  hostName = data.host;

  if (!myName) myName = hostName; // è‡ªåˆ†ã§ä½œã£ãŸãƒ«ãƒ¼ãƒ ãªã‚‰è¦ªæ‰±ã„

  if (myName !== hostName) {
    document.body.style.backgroundImage = ""; // å­ã¯èƒŒæ™¯éè¡¨ç¤º
  } else {
    document.body.style.backgroundImage = `url('/static/themes/${data.theme}.jpg')`;
  }

  document.getElementById("room-title").textContent =
    `${data.room}ï¼ˆè¦ªï¼š${data.host}ã•ã‚“ï¼‰`;

  document.getElementById("room-id").textContent = roomId;

  const joinURL = `${location.origin}/static/join.html?room=${roomId}`;
  if (myName === hostName) {
    document.getElementById("host-only").style.display = "block";
    document.getElementById("join-url-container").style.display = "block";
    document.getElementById("join-url").value = joinURL;
  } else {
    document.getElementById("join-url-container").style.display = "none";
  }
}

// ===== ãƒ¡ãƒ³ãƒãƒ¼æ›´æ–°ï¼ˆè‡ªå‹•ï¼‰=====
async function updateMembers(auto = false) {
  const res = await fetch(`/room/${roomId}/members`);
  if (!res.ok) return;
  const data = await res.json();

  const prevMembers = document.querySelectorAll("#members div.member");
  const prevNames = Array.from(prevMembers).map(e => e.dataset.name);

  document.getElementById("count").textContent = data.count;

  // å…¥é€€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
  if (auto) {
    // å‚åŠ è€…
    data.members.forEach(m => {
      if (!prevNames.includes(m) && m !== hostName) showPopup(`${m}ã•ã‚“ãŒå‚åŠ ã—ã¾ã—ãŸ`);
    });
    // é€€å‡ºè€…
    prevNames.forEach(m => {
      if (!data.members.includes(m)) showPopup(`${m}ã•ã‚“ãŒé€€å‡ºã—ã¾ã—ãŸ`);
    });
  }

  // ===== è¦ªãƒ»å­ã§è¡¨ç¤ºåˆ‡æ›¿ =====
  const memberList = [];
  memberList.push(`<div class="member" data-name="${hostName}"><strong>${hostName} (è¦ª)</strong></div>`);

  data.members.forEach(m => {
    if (m === hostName) return;
    if (myName === hostName) {
      memberList.push(`<div class="member" data-name="${m}">ãƒ»${m} <button onclick="confirmKick('${m}')">é€€å‡º</button></div>`);
    } else if (m === myName) {
      memberList.push(`<div class="member" data-name="${m}">ãƒ»${m} (è‡ªåˆ†)</div>`);
    } else {
      memberList.push(`<div class="member" data-name="${m}">ãƒ»${m}</div>`);
    }
  });

  document.getElementById("members").innerHTML = memberList.join("<br>");
}

// ===== å®šæœŸæ›´æ–° =====
setInterval(() => updateMembers(true), 3000);

// ===== UIæ“ä½œ =====
function toggleMembers() {
  const box = document.getElementById("members");
  box.style.display = box.style.display === "none" ? "block" : "none";
}

function copyURL() {
  const input = document.getElementById("join-url");
  input.select();
  navigator.clipboard.writeText(input.value);
  showPopup("å‚åŠ URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
}

function showPopup(text) {
  const popup = document.getElementById("popup");
  popup.textContent = text;
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", 3000);
}

// ===== è¦ªå°‚ç”¨ å¼·åˆ¶é€€å‡º =====
function confirmKick(name) {
  if (confirm(`${name}ã•ã‚“ã‚’é€€å‡ºã•ã›ã¾ã™ã‹ï¼Ÿ`)) kick(name);
}

async function kick(name) {
  await fetch(`/room/${roomId}/kick`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ name })
  });
  updateMembers();

  // å­ãŒå¼·åˆ¶é€€å‡ºå¯¾è±¡ãªã‚‰kickç”»é¢ã¸
  if (name === myName && myName !== hostName) {
    window.location.href = `/static/kick.html?room=${roomId}&host=${encodeURIComponent(hostName)}&roomName=${encodeURIComponent(document.getElementById("room-title").textContent.split('ï¼ˆ')[0])}`;
  }
}

// ===== è¦ªå°‚ç”¨ ã‚²ãƒ¼ãƒ é¸æŠ =====
function selectGame() { alert("ã‚²ãƒ¼ãƒ é¸æŠï¼ˆå¾Œã§å®Ÿè£…ï¼‰"); }

// ===== é€€å‡º =====
function exitRoom() {
  if (myName === hostName) {
    if (!confirm("ãƒ«ãƒ¼ãƒ ã‚’é–‰ã˜ã¾ã™ã‹ï¼Ÿ")) return;
    // è¦ªãŒé€€å‡ºã™ã‚‹ã¨ãƒ«ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹â†’å­å…¨å“¡kick
    fetch(`/room/${roomId}/close`, { method: "POST" })
      .then(() => { location.href = "/static/index.html"; });
  } else {
    // å­ã¯è‡ªåˆ†ã§é€€å‡ºâ†’kickç”»é¢
    window.location.href = `/static/kick.html?room=${roomId}&host=${encodeURIComponent(hostName)}&roomName=${encodeURIComponent(document.getElementById("room-title").textContent.split('ï¼ˆ')[0])}`;
  }
}

// ===== å­ãŒã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦é–‰ã˜ãŸå ´åˆã‚‚é€€å‡ºæ‰±ã„ =====
window.addEventListener("beforeunload", async function() {
  if (myName && myName !== hostName) {
    await fetch(`/room/${roomId}/kick`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ name: myName })
    });
  }
});

loadRoom();
updateMembers();
</script>

</body>
</html>
