<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ«ãƒ¼ãƒ </title>

<style>
html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  font-family: sans-serif;
  color: white;
}
body { background-size: cover; background-position: center; }
.exit { position: fixed; top: 20px; right: 20px; padding: 8px 14px; cursor: pointer; }
.room-ui { background: rgba(0,0,0,0.65); padding: 24px; margin: 40px; border-radius: 14px; max-width: 600px; }
button { cursor: pointer; padding: 6px 12px; margin-left: 6px; }
#join-url { width: 36ch; }
#popup { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 12px 18px; border-radius: 10px; display: none; }
</style>
</head>

<body>

<button class="exit" onclick="exitRoom()">é€€å‡º</button>

<div class="room-ui">
  <h1 id="room-title">èª­ã¿è¾¼ã¿ä¸­...</h1>

  <p>
    ãƒ«ãƒ¼ãƒ IDï¼š<strong id="room-id"></strong> /
    å‚åŠ äººæ•°ï¼š<strong id="count">0</strong>äºº
    <button onclick="toggleMembers()">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¦‹ã‚‹</button>
  </p>

  <div id="members" style="display:none; margin-bottom:10px;"></div>

  <p id="join-url-container">
    å‚åŠ URLï¼š
    <input id="join-url" readonly>
    <button onclick="copyURL()">ã‚³ãƒ”ãƒ¼</button>
  </p>

  <div id="host-only" style="display:none; margin-top:20px;">
    <button onclick="selectGame()">ğŸ® ã‚²ãƒ¼ãƒ ã‚’é¸ã¶ï¼ˆè¦ªã®ã¿ï¼‰</button>
  </div>
</div>

<div id="popup"></div>

<script>
const params = new URLSearchParams(location.search);
const roomId = params.get("room");
let myName = params.get("name") || "";

let hostName = "";

// ===== ãƒ«ãƒ¼ãƒ æƒ…å ±èª­ã¿è¾¼ã¿ =====
async function loadRoom() {
  const res = await fetch(`/room/${roomId}`);
  if (!res.ok) {
    if (myName) goKick();
    return;
  }

  const data = await res.json();
  hostName = data.host;

  if (!myName) myName = hostName;

  if (myName === hostName) {
    document.body.style.backgroundImage =
      `url('/static/themes/${data.theme}.jpg')`;
  } else {
    document.body.style.backgroundImage = "";
  }

  document.getElementById("room-title").textContent =
    `${data.room}ï¼ˆè¦ªï¼š${data.host}ã•ã‚“ï¼‰`;

  document.getElementById("room-id").textContent = roomId;

  const joinURL = `${location.origin}/static/join.html?room=${roomId}`;
  if (myName === hostName) {
    document.getElementById("host-only").style.display = "block";
    document.getElementById("join-url").value = joinURL;
  } else {
    document.getElementById("join-url-container").style.display = "none";
  }
}

// ===== ãƒ¡ãƒ³ãƒãƒ¼æ›´æ–° =====
async function updateMembers(auto = false) {
  const res = await fetch(`/room/${roomId}/members`);

  // â˜… è¦ªãŒãƒ«ãƒ¼ãƒ ã‚’é–‰ã˜ãŸ
  if (!res.ok) {
    if (myName !== hostName) goKick();
    return;
  }

  const data = await res.json();
  document.getElementById("count").textContent = data.count;

  // â˜… è‡ªåˆ†ãŒkickã•ã‚Œã¦ã„ãŸ
  if (auto && myName !== hostName && !data.members.includes(myName)) {
    goKick();
    return;
  }

  const memberList = [];

  // è¦ª
  memberList.push(
    `<div class="member" data-name="${hostName}">
      <strong>${hostName} (è¦ª)</strong>
     </div>`
  );

  // è‡ªåˆ†ï¼ˆè¦ªä»¥å¤–ï¼‰
  if (myName !== hostName && data.members.includes(myName)) {
    memberList.push(
      `<div class="member" data-name="${myName}">
        ãƒ»${myName} (è‡ªåˆ†)
       </div>`
    );
  }

  // ãã®ä»–ï¼ˆå…¥å®¤é †ï¼‰
  data.members.forEach(m => {
    if (m === hostName || m === myName) return;

    if (myName === hostName) {
      memberList.push(
        `<div class="member" data-name="${m}">
          ãƒ»${m}
          <button onclick="confirmKick('${m}')">é€€å‡º</button>
         </div>`
      );
    } else {
      memberList.push(
        `<div class="member" data-name="${m}">
          ãƒ»${m}
         </div>`
      );
    }
  });

  document.getElementById("members").innerHTML = memberList.join("<br>");
}

// ===== å®šæœŸæ›´æ–° =====
setInterval(() => updateMembers(true), 3000);

// ===== UI =====
function toggleMembers() {
  const box = document.getElementById("members");
  box.style.display = box.style.display === "none" ? "block" : "none";
}

function copyURL() {
  const input = document.getElementById("join-url");
  input.select();
  navigator.clipboard.writeText(input.value);
  showPopup("å‚åŠ URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
}

function showPopup(text) {
  const popup = document.getElementById("popup");
  popup.textContent = text;
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", 3000);
}

// ===== kick =====
function confirmKick(name) {
  if (confirm(`${name}ã•ã‚“ã‚’é€€å‡ºã•ã›ã¾ã™ã‹ï¼Ÿ`)) kick(name);
}

async function kick(name) {
  await fetch(`/room/${roomId}/kick`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ name })
  });
}

// ===== é€€å‡º =====
function exitRoom() {
  if (myName === hostName) {
    if (!confirm("ãƒ«ãƒ¼ãƒ ã‚’é–‰ã˜ã¾ã™ã‹ï¼Ÿ")) return;
    fetch(`/room/${roomId}/close`, { method: "POST" })
      .then(() => location.href = "/static/index.html");
  } else {
    goKick();
  }
}

// ===== kickç”»é¢é·ç§» =====
function goKick() {
  location.href =
    `/static/kick.html?room=${roomId}&host=${encodeURIComponent(hostName)}&roomName=${encodeURIComponent(document.getElementById("room-title").textContent.split('ï¼ˆ')[0])}`;
}

// ===== ã‚¿ãƒ–é–‰ã˜ =====
window.addEventListener("beforeunload", () => {
  if (myName && myName !== hostName) {
    fetch(`/room/${roomId}/kick`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ name: myName })
    });
  }
});

loadRoom();
updateMembers();
</script>

</body>
</html>
