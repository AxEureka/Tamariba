<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background-size: cover;
      background-position: center;
      color: #fff;
    }

    .overlay {
      background: rgba(0,0,0,0.55);
      min-height: 100vh;
      padding: 20px;
    }

    h1 {
      margin-top: 0;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      padding: 6px 0;
    }

    button {
      font-size: 1rem;
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    .danger {
      background: #c0392b;
      color: #fff;
    }
  </style>
</head>

<body>
<div class="overlay">
  <h1 id="room-title"></h1>

  <h2>参加者</h2>
  <ul id="member-list"></ul>

  <button id="close-room" class="danger" style="display:none;">
    ルームを閉じる
  </button>
</div>

<script>
/* =============================
   初期設定・ガード
============================= */

const params = new URLSearchParams(location.search);
const roomId = params.get("room");
let myName = params.get("name") || "";

if (!sessionStorage.getItem("joinedRoom")) {
  location.href = "/static/index.html";
}

let hostName = "";
let auto = true;
let firstUpdate = true;

/* =============================
   Kick 処理
============================= */

function goKick() {
  sessionStorage.removeItem("joinedRoom");
  location.href =
    `/static/kick.html?room=${roomId}` +
    `&host=${encodeURIComponent(hostName)}` +
    `&roomName=${encodeURIComponent(
      document.getElementById("room-title").textContent.split("（")[0]
    )}`;
}

/* =============================
   ルーム情報ロード
============================= */

async function loadRoom() {
  const res = await fetch(`/room/${roomId}`);
  if (!res.ok) {
    goKick();
    return;
  }

  const data = await res.json();

  hostName = data.host;

  document.getElementById("room-title").textContent =
    `${data.name}（ホスト：${hostName}）`;

  // ★ 親子関係なく背景を表示
  document.body.style.backgroundImage =
    `url('/static/themes/${data.theme}.jpg')`;

  // ホストのみ「閉じる」ボタン表示
  if (myName === hostName) {
    document.getElementById("close-room").style.display = "inline-block";
  }

  updateMembers(data);
}

/* =============================
   メンバー更新
============================= */

function updateMembers(data) {
  const ul = document.getElementById("member-list");
  ul.innerHTML = "";

  data.members.forEach(name => {
    const li = document.createElement("li");
    li.textContent = name + (name === hostName ? "（ホスト）" : "");
    ul.appendChild(li);
  });

  // ★ kick 判定（初回 update は除外）
  if (
    auto &&
    !firstUpdate &&
    myName !== hostName &&
    !data.members.includes(myName)
  ) {
    goKick();
    return;
  }

  firstUpdate = false;
}

/* =============================
   ポーリング
============================= */

setInterval(async () => {
  try {
    const res = await fetch(`/room/${roomId}`);
    if (!res.ok) {
      goKick();
      return;
    }
    const data = await res.json();
    updateMembers(data);
  } catch (e) {
    console.error(e);
  }
}, 2000);

/* =============================
   ルーム閉鎖（ホスト）
============================= */

document.getElementById("close-room").onclick = async () => {
  await fetch(`/room/${roomId}/close`, { method: "POST" });
  sessionStorage.removeItem("joinedRoom");
  location.href = "/static/index.html";
};

/* =============================
   初期ロード
============================= */

loadRoom();
</script>
</body>
</html>
